{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto" 
     x-data="financeApp({
        total_entradas: {{ total_entradas }},
        total_gastos: {{ total_gastos }},
        saldo: {{ saldo }},
        snoopy_imagem: '{{ snoopy_imagem }}'
     })">
    
    <h1 class="text-3xl font-bold text-center text-snoopy-dark mb-4">
        Snoopy Finance
    </h1>

    <div class="mb-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="p-4 rounded-md 
                          {% if category == 'danger' %} bg-red-100 text-red-700 
                          {% else %} bg-green-100 text-green-700 {% endif %}"
                   role="alert">
                <p class="font-bold">{% if category == 'danger' %}Erro!{% else %}Sucesso!{% endif %}</p>
                <p>{{ message }}</p>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center flex flex-col justify-center items-center">
            <img :src="snoopy_imagem" 
                 alt="Snoopy Status" class="mx-auto h-48 w-48 object-cover mb-4">
            <p x-text="snoopy_texto" :class="['text-lg font-semibold', snoopy_cor]"></p>
        </div>

        <div class="space-y-4">
            <div class="bg-green-100 p-4 rounded-lg shadow">
                <h2 class="text-sm font-medium text-green-700">Entradas (Recebido)</h2>
                <p class="text-2xl font-bold text-green-800" x-text="'R$ ' + total_entradas.toLocaleString('pt-BR', {minimumFractionDigits: 2})">
                    R$ {{ "%.2f"|format(total_entradas) }}
                </p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow">
                <h2 class="text-sm font-medium text-red-700">Saídas (Pago)</h2>
                <p class="text-2xl font-bold text-red-800" x-text="'R$ ' + total_gastos.toLocaleString('pt-BR', {minimumFractionDigits: 2})">
                    R$ {{ "%.2f"|format(total_gastos) }}
                </p>
            </div>
            <div class="bg-blue-100 p-4 rounded-lg shadow">
                <h2 class="text-sm font-medium text-blue-700">Saldo Atual</h2>
                <p class="text-2xl font-bold text-blue-800" x-text="'R$ ' + saldo.toLocaleString('pt-BR', {minimumFractionDigits: 2})">
                    R$ {{ "%.2f"|format(saldo) }}
                </p>
            </div>
        </div>
    </div>
    
    <div class="flex justify-center gap-4 mb-6">
        <button @click="showGastoForm = !showGastoForm; showEntradaForm = false" 
                class="bg-snoopy-red text-white font-bold py-2 px-6 rounded-full shadow-lg hover:bg-red-600 transition-all">
            Adicionar Gasto
        </button>
        <button @click="showEntradaForm = !showEntradaForm; showGastoForm = false" 
                class="bg-snoopy-blue text-white font-bold py-2 px-6 rounded-full shadow-lg hover:bg-blue-600 transition-all">
            Adicionar Entrada
        </button>
        
        <button @click="toggleCharts()" 
                class="bg-purple-500 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:bg-purple-600 transition-all">
            Ver Gráficos
        </button>
    </div>

    <form x-show="showGastoForm" x-cloak action="{{ url_for('main.add_gasto') }}" method="POST" 
      class="bg-white p-6 rounded-lg shadow-lg mb-8">
        <h3 class="text-xl font-bold text-snoopy-red mb-4">Novo Gasto</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="date" name="data" class="p-2 border rounded" required>
            <input type="number" step="0.01" name="valor" placeholder="Valor (ex: 50.00)" class="p-2 border rounded" required>
            <input type="text" name="categoria" placeholder="Categoria (ex: Lazer)" class="p-2 border rounded" required>
            <select name="tipo_gasto" class="p-2 border rounded">
                <option value="variavel">Variável</option>
                <option value="fixo">Fixo</option>
            </select>
            <select name="tipo_pagamento" class="p-2 border rounded">
                <option value="Débito">Débito</option>
                <option value="Credito">Crédito</option>
                <option value="Pix">Pix</option>
            </select>
            <select name="tipo_banco" class="p-2 border rounded">
                <option value="Nubank">Nubank</option>
                <option value="Inter">Inter</option>
                <option value="PicPay">PicPay</option>
                <option value="Santander">Santander</option>
                <option value="BancoDoNordeste">Banco do Nordeste</option>
                <option value="BancoDoBrasil">Banco do Brasil</option>
                <option value="CaixaEconômica">Caixa Econômica</option>
                <option value="Itau">Itaú</option>
                <option value="Bradesco">Bradesco</option>
                <option value="C6Bank">C6 Bank</option>
                <option value="Next">Next</option>
                <option value="BTGPactual">BTG Pactual</option>
            </select>
            <button type="submit" class="bg-snoopy-red text-white p-2 rounded col-span-1 md:col-span-3">Salvar Gasto</button>
        </div>
    </form>

    <form x-show="showEntradaForm" x-cloak action="{{ url_for('main.add_entrada') }}" method="POST" 
      class="bg-white p-6 rounded-lg shadow-lg mb-8">
        <h3 class="text-xl font-bold text-snoopy-blue mb-4">Nova Entrada</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="date" name="data" class="p-2 border rounded" required>
            <input type="number" step="0.01" name="valor" placeholder="Valor (ex: 1500.00)" class="p-2 border rounded" required>
            <input type="text" name="nome" placeholder="Nome (ex: Salário)" class="p-2 border rounded" required>
            <button type="submit" class="bg-snoopy-blue text-white p-2 rounded col-span-1 md:col-span-3">Salvar Entrada</button>
        </div>
    </form>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold text-snoopy-blue mb-4">Planilha de Entradas</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left min-w-[400px]">
                    <thead>
                        <tr class="border-b-2 border-snoopy-blue">
                            <th class="py-2">Nome</th><th class="py-2">Data</th><th class="py-2">Valor</th><th class="py-2 text-center">Entrou?</th><th class="py-2 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entrada in entradas %}
                        <tr class="border-b border-gray-200 transition-all duration-200 {% if entrada.concluido %}text-gray-400 line-through opacity-70{% endif %}">
                            <td class="py-2">{{ entrada.nome }}</td>
                            <td class="py-2">{{ entrada.data.strftime('%d/%m/%Y') }}</td>
                            <td class="py-2">R$ {{ "%.2f"|format(entrada.valor) }}</td>
                            <td class="py-2 text-center">
                                <input type="checkbox" 
                                       @click="toggleEntrada({{ entrada.id }}, {{ entrada.valor }}, $el)"
                                       {% if entrada.concluido %}checked{% endif %}
                                       class="h-5 w-5 text-snoopy-blue rounded cursor-pointer">
                            </td>
                            <td class="py-2 text-center flex justify-center gap-2">
                                <button @click="openEditEntrada({{ entrada.id }})" class="text-blue-500 hover:text-blue-700" title="Editar">✏️</button>
                                <button @click="deleteEntrada({{ entrada.id }}, {{ entrada.valor }}, {{ 'true' if entrada.concluido else 'false' }}, $el)" class="text-red-500 hover:text-red-700 font-bold" title="Apagar">&times;</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" class="py-4 text-gray-500 text-center">Nenhuma entrada cadastrada.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold text-snoopy-red mb-4">Planilha de Gastos</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left min-w-[700px]">
                    <thead>
                        <tr class="border-b-2 border-snoopy-red">
                            <th class="py-2">Data</th><th class="py-2">Categoria</th><th class="py-2">Tipo</th><th class="py-2">Banco</th><th class="py-2">Valor</th><th class="py-2 text-center">Pago?</th><th class="py-2 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for gasto in gastos %}
                        <tr class="border-b border-gray-200 transition-all duration-200 {% if gasto.concluido %}text-gray-400 line-through opacity-70{% endif %}">
                            <td class="py-2">{{ gasto.data.strftime('%d/%m/%Y') }}</td>
                            <td class="py-2">{{ gasto.categoria }}</td>
                            <td class="py-2">{{ gasto.tipo_pagamento }}</td>
                            <td class="py-2">{{ gasto.banco }}</td>
                            <td class="py-2">R$ {{ "%.2f"|format(gasto.valor) }}</td>
                            <td class="py-2 text-center">
                                <input type="checkbox" 
                                       @click="toggleGasto({{ gasto.id }}, {{ gasto.valor }}, $el)" 
                                       {% if gasto.concluido %}checked{% endif %} 
                                       class="h-5 w-5 text-snoopy-red rounded cursor-pointer">
                            </td>
                            <td class="py-2 text-center flex justify-center gap-2">
                                <button @click="openEditGasto({{ gasto.id }})" class="text-blue-500 hover:text-blue-700" title="Editar">✏️</button>
                                <button @click="deleteGasto({{ gasto.id }}, {{ gasto.valor }}, {{ 'true' if gasto.concluido else 'false' }}, $el)" class="text-red-500 hover:text-red-700 font-bold" title="Apagar">&times;</button>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="7" class="py-4 text-gray-500 text-center">Nenhum gasto cadastrado.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div x-show="chartError" x-cloak x-transition class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative my-4 max-w-lg mx-auto" role="alert">
      <span class="block sm:inline" x-text="chartError"></span>
      <span @click="chartError = ''" class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer">
        <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Fechar</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 2.651a1.2 1.2 0 1 1-1.697-1.697L8.304 10 5.652 7.349a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-2.651a1.2 1.2 0 1 1 1.697 1.697L11.697 10l2.651 2.651a1.2 1.2 0 0 1 0 1.698z"/></svg>
      </span>
    </div>

    <div x-show="showCharts" x-cloak x-transition 
         class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-xl font-bold text-center text-gray-700 mb-4">Gastos por Categoria</h3>
            <canvas id="categoryChart"></canvas>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h3 class="text-xl font-bold text-center text-purple-600 mb-4">Gastos por Banco</h3>
            <canvas id="bankChart"></canvas>
        </div>
    </div>

    <div x-show="editGastoModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold text-snoopy-red mb-4">Editar Gasto</h3>
            <form :action="'/edit_gasto/' + editGastoData.id" method="POST" class="space-y-4">
                <div><label>Data</label><input type="date" name="data" x-model="editGastoData.data" class="w-full p-2 border rounded" required></div>
                <div><label>Valor</label><input type="number" step="0.01" name="valor" x-model="editGastoData.valor" class="w-full p-2 border rounded" required></div>
                <div><label>Categoria</label><input type="text" name="categoria" x-model="editGastoData.categoria" class="w-full p-2 border rounded" required></div>
                <div><label>Tipo</label>
                    <select name="tipo_gasto" x-model="editGastoData.tipo_gasto" class="w-full p-2 border rounded">
                        <option value="variavel">Variável</option><option value="fixo">Fixo</option>
                    </select>
                </div>
                <div><label>Pagamento</label>
                    <select name="tipo_pagamento" x-model="editGastoData.tipo_pagamento" class="w-full p-2 border rounded">
                         <option value="Débito">Débito</option><option value="Credito">Crédito</option><option value="Pix">Pix</option>
                    </select>
                </div>
                <div><label>Banco</label>
                    <select name="tipo_banco" x-model="editGastoData.banco" class="w-full p-2 border rounded">
                        <option value="Nubank">Nubank</option><option value="Inter">Inter</option><option value="PicPay">PicPay</option><option value="Santander">Santander</option><option value="BancoDoNordeste">Banco do Nordeste</option><option value="BancoDoBrasil">Banco do Brasil</option><option value="CaixaEconômica">Caixa Econômica</option><option value="Itau">Itaú</option><option value="Bradesco">Bradesco</option><option value="C6Bank">C6 Bank</option><option value="Next">Next</option><option value="BTGPactual">BTG Pactual</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" @click="editGastoModal = false" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-snoopy-red text-white rounded hover:bg-red-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <div x-show="editEntradaModal" x-cloak class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-2xl font-bold text-snoopy-blue mb-4">Editar Entrada</h3>
            <form :action="'/edit_entrada/' + editEntradaData.id" method="POST" class="space-y-4">
                <div><label>Data</label><input type="date" name="data" x-model="editEntradaData.data" class="w-full p-2 border rounded" required></div>
                <div><label>Valor</label><input type="number" step="0.01" name="valor" x-model="editEntradaData.valor" class="w-full p-2 border rounded" required></div>
                <div><label>Nome</label><input type="text" name="nome" x-model="editEntradaData.nome" class="w-full p-2 border rounded" required></div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" @click="editEntradaModal = false" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-snoopy-blue text-white rounded hover:bg-blue-700">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

</div> {% block scripts %}
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

{% endblock %}